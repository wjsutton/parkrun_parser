---
output:
  html_document: default
---
<img style="float: left;width: 150px" src="http://west4harriers.com/wp-content/uploads/2016/03/west4_harriers_running_club2-1.png">
```{r setup, include=FALSE}
library(dplyr)
library(knitr)
library(kableExtra)
library(formattable)
report <- read.csv("w4h_parkrun_report.csv",stringsAsFactors = F)

output <- report %>% filter(date == max(report$date))
new_pb <- ifelse(output$note == 'New PB!','Yes','No')
output <- cbind(output,new_pb)
output$age_grade <- as.double(substr(output$age_grade,1,nchar(output$age_grade)-2))

parkruns <- sort(unique(output$parkrun))
parkrunners <- length(unique(output$parkrunner))
pbs <- nrow(output %>% filter(note == 'New PB!'))
top10s <- nrow(output %>% filter(gender_position <= 10))
ag75 <- nrow(data.frame(ag=as.double(substr(output$age_grade,1,nchar(output$age_grade)-2))) %>% filter(ag >= 75))
locations <- length(parkruns)

milestones <- output %>% filter(output$total_runs %% 25 == 0)
milestones <- milestones[,c(5,13)]
names(milestones) <- c("Parkrunner","Total Runs")
milestones_upcoming <- output %>% filter(output$total_runs %% 25 %in% c(22,23,24))
milestones_upcoming <- milestones_upcoming[,c(5,13)]
runs_to_go <- paste0(25 - (milestones_upcoming$total_runs %% 25),ifelse(25 - (milestones_upcoming$total_runs %% 25)==1,' parkrun away from ',' parkruns away from '),(25 - (milestones_upcoming$total_runs %% 25)+milestones_upcoming$total_runs))

milestones_upcoming <- cbind(milestones_upcoming,runs_to_go)
milestones_upcoming <- milestones_upcoming[order(rev(milestones_upcoming$total_runs)),]
milestones_upcoming <- milestones_upcoming[,c(1,3)]
names(milestones_upcoming) <- c("Parkrunner","Runs to go")
```

<h3>Parkrun Report `r format(as.Date(max(report$date)),format="%d %b %Y")`</h3>
#
<div style="padding:10px;">
<p>![](running-a-race.png){width=50px} <elem style="font-weight: bold; font-size: 150%">`r parkrunners`</elem> Parkrunners</p>
<p>![](009-thumbs-up-hand-symbol.png){width=50px} <elem style="font-weight: bold; font-size: 150%">`r pbs`</elem> New PBs</p>
<p>![](005-medal-1.png){width=50px} <elem style="font-weight: bold; font-size: 150%">`r top10s`</elem> Top 10 Finishes</p>
<p>![](007-superman-flying.png){width=50px} <elem style="font-weight: bold; font-size: 150%">`r ag75`</elem> Age Grade Finishes +75%</p>
<p>![](008-earth.png){width=50px} <elem style="font-weight: bold; font-size: 150%">`r locations`</elem> Parkruns Visited</p>
</div>
<p>
</p>
```{r, echo=FALSE}
mile_header <- ifelse(nrow(milestones)>0,'Milestones','')
mile_table <- ifelse(nrow(milestones)>0, milestones %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")),'')
mile <- paste('<h4 style="background-color:#bedff6; padding: 7px;">',mile_header,"</h4>",mile_table,'\n\n\n',sep = '\n')
mile_up_header <- ifelse(nrow(milestones_upcoming)>0,'Upcoming Milestones','')
mile_up_table <- ifelse(nrow(milestones_upcoming)>0, milestones_upcoming %>% kable(row.names = F) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")),'')
mile_up <- paste('<h4 style="background-color:#bedff6; padding: 7px;">',mile_up_header,"</h4>",mile_up_table,'\n\n\n',sep = '\n')
```

`r mile`
`r mile_up`

### Weekly Results
```{r, echo=FALSE}
test <- ''
for (i in 1:locations) {
  table <- output %>% filter(parkrun == parkruns[i])
  header <- paste0(parkruns[i],' #',unique(table$number))
  results <- table[,c(4,10,5,15,6,8,13)] 
  names(results) <- c('Pos.','Gender Pos.','Parkrunner','New PB?','Time','Age Grade (%)','Total Runs')
  results <- results %>% kable() %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) 
  test <- paste(test,'<h4 style="background-color:#bedff6; padding: 7px;">',header,"</h4>",results,'\n\n\n',sep = '\n')
}
```

`r test`

<p>Generated from Parkrun Consolidated Club Reports: <a href="http://www.parkrun.com/results/consolidatedclub/?clubNum=1242">here</a></p> 
